
<html>
	<head>
		<title>The CampMap!</title>

		<link rel="stylesheet" href="leaflet-0.7.3/leaflet.css" />
		<link rel="stylesheet" href="leaflet-plugins/Leaflet.Draw/leaflet.draw.css" />
		<link rel="stylesheet" href="leaflet-plugins/Leaflet.MeasureControl/leaflet.measurecontrol.css" />

		<link rel="stylesheet" href="gh-fork-ribbon/gh-fork-ribbon.min.css" />
		<!--[if lt IE 9]>
		  <link rel="stylesheet" href="gh-fork-ribbon/gh-fork-ribbon.ie.min.css" />
		<![endif]-->

		<style type="text/css">
			body {
				padding: 0;
				margin: 0;
			}

			.leaflet-container, body {
				background: black;
			}

			#map {
				width: 100%;
				height: 100%;
			}

			.leaflet-control-layers ul {
				padding-left: 22px;
			}

			.leaflet-control-layers ul li.gap {
				margin-top: 10px;
			}

			.leaflet-control-layers ul li .leaflet-control {
				float: none;
				padding: 0;
			}

			.leaflet-control-layers ul li a {
				text-decoration: none;
			}

			.leaflet-control-layers ul li a.leaflet-control-draw-measure {
				background: none;
			}

			.leaflet-bottom {
				z-index: 10000;
			}
		</style>

		<!-- load the leaflet javascript library -->
		<script src="jquery-1.11.3.min.js"></script>
		<script src="leaflet-0.7.3/leaflet.js"></script>
		<script src="leaflet-plugins/Permalink.js"></script>
		<script src="leaflet-plugins/Permalink.Layer.js"></script>
		<script src="leaflet-plugins/Bing.js"></script>
		<script src="leaflet-plugins/Leaflet.Draw/leaflet.draw.js"></script>
		<script src="leaflet-plugins/Leaflet.MeasureControl/leaflet.measurecontrol.js"></script>

		<script type="text/javascript">
			var attribution = 'Tiles under PD0, Data under OdbL';

			function init()
			{
				////////// MAP SETUP //////////
				var basemap = new L.BingLayer('AgUjrAV3ggamKtrsPI9ruw06v8vStpmRQlQ16te0eLfYKKF6ZLy-MIFx__84B_gQ', {
					maxNativeZoom: 18,
					maxZoom: 21,
					attribution: '',

					opacity: 0.50
				});

				var initial_overlays = ['landuse', 'ways', 'buildings', 'tents', 'noc'];
				var overlays =         ['landuse', 'ways', 'buildings', 'tents', 'noc', 'gpscoords'];
				var layers = [basemap];
				var overlayers = {};
				for (var i = 0; i < overlays.length; i++) {
					var name = overlays[i]
					overlayers[name] = new L.TileLayer('http://{s}.tiles.campmap.mazdermind.de/campmap-'+name+'/{z}/{x}/{y}.png', {
						subdomains: 'abcd',
						maxZoom: 21,
						attribution: attribution,
						scheme: 'xyz',
						errorTileUrl: 'http://maps.personalwerk.de/404.png'
					});
				};

				for (var i = 0; i < initial_overlays.length; i++) {
					var key = initial_overlays[i];
					layers.push(overlayers[key]);
				};

				var map = new L.Map('map', {
					layers: layers,
					center: new L.LatLng(53.03131, 13.30906),
					zoom: 17,
					measureControl: true,

					// issues with lots and lots of transparent tiles
					fadeAnimation: false,
					zoomAnimation: false
				});
				window.map = map;

				var layersControl = new L.Control.Layers({}, overlayers, {collapsed: false});
				var permalinkControl = new L.Control.Permalink({layers: layersControl});
				map.addControl(layersControl);
				map.addControl(permalinkControl);

				var scaleControl = new L.Control.Scale();
				map.addControl(scaleControl);
				////////// END MAP SETUP //////////




				////////// TOOLBOX SETUP //////////
				var $ul = $('<ul>');

				$.each([100, 75, 50, 25, 0], function(idx, opacity) {
					$('<li>').append( $('<a href="javascript:;">').text('Background '+opacity+'%').on('click', function() {
						basemap.setOpacity(opacity/100);
					})).appendTo($ul);
				});

				$('<li class="gap">').append( $('<a href="javascript:;">').text('Background White').on('click', function() {
					$('.leaflet-container, body').css('background', 'white');
				})).appendTo($ul);

				$('<li>').append( $('<a href="javascript:;">').text('Background Black').on('click', function() {
					$('.leaflet-container, body').css('background', 'black');
				})).appendTo($ul);

				$('<li class="gap">')
					.append( $('.leaflet-control-permalink') )
					.appendTo($ul);

				$('<li>')
					.append( $('.leaflet-control-draw-measure').text('Measure distances') )
					.appendTo($ul);

				var $hires = $('<a href="#" target="blank">').text('HiRes Export').on('click', function(e) {
					// 
				});

				function updateHiRes() {
					var enabledOverlays = [];
					for (var idx in layersControl._layers) {
						var layer = layersControl._layers[idx];
						if(layer.overlay && layer.layer._leaflet_id in map._layers)
							enabledOverlays.push(layer.name);
					}

					var bounds = map.getBounds();
					$hires.attr('href',
						'export/'+L.Util.getParamString({
							bbox: bounds.getSouthWest().lng+','+bounds.getSouthWest().lat+','+bounds.getNorthEast().lng+','+bounds.getNorthEast().lat,
							zoom: map.getZoom(),
							overlays: enabledOverlays.join('.')
						})
					)
				}
				map.on('moveend overlayadd overlayremove', updateHiRes);
				updateHiRes();

				$('<li>').append($hires).appendTo($ul);

				$('.leaflet-control-layers-list').append([
					'<hr>',
					$ul,
				]);
				////////// END TOOLBOX SETUP //////////
			}
		</script>
	</head>

	<body onload="init();">
		<div id="map"></div>

		<div class="github-fork-ribbon-wrapper right-bottom">
			<div class="github-fork-ribbon">
				<a href="https://github.com/MaZderMind/campmap/" target="_blank">GitHub</a>
			</div>
		</div>
	</body>
</html>
